// Generated by Haxe 4.1.0-rc.1+0d88c583b
using haxe.root;

#pragma warning disable 109, 114, 219, 429, 168, 162
namespace hx.ws {
	public class WebSocket : global::hx.ws.WebSocketCommon {
		
		public WebSocket(global::haxe.lang.EmptyObject empty) : base(((global::haxe.lang.EmptyObject) (global::haxe.lang.EmptyObject.EMPTY) )) {
		}
		
		
		public WebSocket(string uri) : base(((global::haxe.lang.EmptyObject) (global::haxe.lang.EmptyObject.EMPTY) )) {
			global::hx.ws.WebSocket.__hx_ctor_hx_ws_WebSocket(this, uri);
		}
		
		
		protected static void __hx_ctor_hx_ws_WebSocket(global::hx.ws.WebSocket __hx_this, string uri) {
			unchecked {
				__hx_this._encodedKey = "wskey";
				__hx_this._key = "wskey";
				{
					global::haxe.root.EReg uriRegExp = new global::haxe.root.EReg("^(\\w+?)://([\\w\\.-]+)(:(\\d+))?(/.*)?$", "");
					if ( ! (uriRegExp.match(uri)) ) {
						throw global::haxe.lang.HaxeException.wrap(global::haxe.lang.Runtime.concat(global::haxe.lang.Runtime.concat("Uri not matching websocket uri \"", uri), "\""));
					}
					
					string proto = uriRegExp.matched(1);
					if (( proto == "wss" )) {
						throw global::haxe.lang.HaxeException.wrap("Secure sockets not implemented");
					}
					else if (( proto == "ws" )) {
						__hx_this._port = 80;
						global::hx.ws.WebSocketCommon.__hx_ctor_hx_ws_WebSocketCommon(__hx_this, null);
					}
					else {
						throw global::haxe.lang.HaxeException.wrap(global::haxe.lang.Runtime.concat("Unknown protocol ", proto));
					}
					
					__hx_this._host = uriRegExp.matched(2);
					object parsedPort = global::haxe.root.Std.parseInt(uriRegExp.matched(4));
					if (( ((int) (global::haxe.lang.Runtime.toInt(parsedPort)) ) > 0 )) {
						__hx_this._port = ((int) (global::haxe.lang.Runtime.toInt(parsedPort)) );
					}
					
					__hx_this._uri = uriRegExp.matched(5);
					if (( ( __hx_this._uri == null ) || ( __hx_this._uri.Length == 0 ) )) {
						__hx_this._uri = "/";
					}
					
					__hx_this._socket.setBlocking(true);
					__hx_this._socket.connect(new global::sys.net.Host(((string) (__hx_this._host) )), __hx_this._port);
					__hx_this._socket.setBlocking(false);
					global::hx.ws.WebSocket ws = __hx_this;
					global::haxe.MainLoop.addThread(new global::hx.ws.WebSocket___hx_ctor_hx_ws_WebSocket_182__Fun(ws));
					__hx_this.sendHandshake();
				}
				
			}
		}
		
		
		public string _host;
		
		public int _port;
		
		public string _uri;
		
		public global::sys.thread._Thread.HaxeThread _processThread;
		
		public string _key;
		
		public string _encodedKey;
		
		public string binaryType;
		
		public virtual void processThread() {
			unchecked {
				global::hx.ws.WebSocket ws = ((global::hx.ws.WebSocket) (global::sys.thread._Thread.Thread_Impl_.readMessage(true)) );
				global::hx.ws.Log.debug("Thread started", ws.id);
				while (( ws.state != global::hx.ws.State.Closed )) {
					ws.process();
					global::System.Threading.Thread.Sleep(((int) (10) ));
				}
				
				global::hx.ws.Log.debug("Thread ended", ws.id);
			}
		}
		
		
		public virtual void sendHandshake() {
			global::hx.ws.HttpRequest httpRequest = new global::hx.ws.HttpRequest();
			httpRequest.method = "GET";
			httpRequest.uri = this._uri;
			httpRequest.httpVersion = "HTTP/1.1";
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Host") ), ((object) (global::haxe.lang.Runtime.concat(global::haxe.lang.Runtime.concat(this._host, ":"), global::haxe.lang.Runtime.toString(this._port))) ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("User-Agent") ), ((object) ("hxWebSockets") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Sec-WebSocket-Version") ), ((object) ("13") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Upgrade") ), ((object) ("websocket") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Connection") ), ((object) ("Upgrade") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Pragma") ), ((object) ("no-cache") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Cache-Control") ), ((object) ("no-cache") ));
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Origin") ), ((object) (global::haxe.lang.Runtime.concat(global::haxe.lang.Runtime.concat(((global::sys.net.Host) (global::haxe.lang.Runtime.getField(this._socket.host(), "host", 1158860648, true)) ).toString(), ":"), global::haxe.lang.Runtime.toString(((int) (global::haxe.lang.Runtime.getField_f(this._socket.host(), "port", 1247576961, true)) )))) ));
			this._encodedKey = global::haxe.crypto.Base64.encode(global::hx.ws.Utf8Encoder.encode(this._key), null);
			((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpRequest.headers) )) ).@set(((string) ("Sec-WebSocket-Key") ), ((object) (this._encodedKey) ));
			this.sendHttpRequest(httpRequest);
		}
		
		
		public override void handleData() {
			if (( this.state._hx_index == 0 )) {
				global::hx.ws.HttpResponse httpResponse = this.recvHttpResponse();
				if (( httpResponse == null )) {
					return;
				}
				
				this.handshake(httpResponse);
				this.handleData();
			}
			else {
				base.handleData();
			}
			
		}
		
		
		public virtual void handshake(global::hx.ws.HttpResponse httpResponse) {
			unchecked {
				global::haxe.Log.trace.__hx_invoke2_o(default(double), httpResponse.toString(), default(double), new global::haxe.lang.DynamicObject(new int[]{302979532, 1547539107, 1648581351}, new object[]{"handshake", "hx.ws.WebSocket", "src/hx/ws/WebSocket.hx"}, new int[]{1981972957}, new double[]{((double) (239) )}));
				if (( httpResponse.code != 101 )) {
					if (( this.onerror != null )) {
						this.onerror.__hx_invoke1_o(default(double), global::haxe.lang.Runtime.toString(((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpResponse.headers) )) ).@get(((string) ("X-WebSocket-Reject-Reason") ))));
					}
					
					this.close();
					return;
				}
				
				string secKey = global::haxe.lang.Runtime.toString(((global::haxe.ds.StringMap) (((global::haxe.IMap) (httpResponse.headers) )) ).@get(((string) ("Sec-WebSocket-Accept") )));
				if (( secKey != global::haxe.crypto.Base64.encode(global::haxe.crypto.Sha1.make(global::haxe.io.Bytes.ofString(global::haxe.lang.Runtime.concat(this._encodedKey, "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"), null)), null) )) {
					if (( this.onerror != null )) {
						this.onerror.__hx_invoke1_o(default(double), "Error during WebSocket handshake: Incorrect \'Sec-WebSocket-Accept\' header value");
					}
					
					this.close();
					return;
				}
				
				this._onopenCalled = false;
				this.state = global::hx.ws.State.Head;
			}
		}
		
		
		public override double __hx_setField_f(string field, int hash, double @value, bool handleProperties) {
			unchecked {
				switch (hash) {
					case 2104336224:
					{
						this._port = ((int) (@value) );
						return @value;
					}
					
					
					default:
					{
						return base.__hx_setField_f(field, hash, @value, handleProperties);
					}
					
				}
				
			}
		}
		
		
		public override object __hx_setField(string field, int hash, object @value, bool handleProperties) {
			unchecked {
				switch (hash) {
					case 1860333403:
					{
						this.binaryType = global::haxe.lang.Runtime.toString(@value);
						return @value;
					}
					
					
					case 1601313232:
					{
						this._encodedKey = global::haxe.lang.Runtime.toString(@value);
						return @value;
					}
					
					
					case 1058852512:
					{
						this._key = global::haxe.lang.Runtime.toString(@value);
						return @value;
					}
					
					
					case 593395418:
					{
						this._processThread = ((global::sys.thread._Thread.HaxeThread) (@value) );
						return @value;
					}
					
					
					case 1059352685:
					{
						this._uri = global::haxe.lang.Runtime.toString(@value);
						return @value;
					}
					
					
					case 2104336224:
					{
						this._port = ((int) (global::haxe.lang.Runtime.toInt(@value)) );
						return @value;
					}
					
					
					case 2015619911:
					{
						this._host = global::haxe.lang.Runtime.toString(@value);
						return @value;
					}
					
					
					default:
					{
						return base.__hx_setField(field, hash, @value, handleProperties);
					}
					
				}
				
			}
		}
		
		
		public override object __hx_getField(string field, int hash, bool throwErrors, bool isCheck, bool handleProperties) {
			unchecked {
				switch (hash) {
					case 875946231:
					{
						return ((global::haxe.lang.Function) (new global::haxe.lang.Closure(this, "handshake", 875946231)) );
					}
					
					
					case 1627978226:
					{
						return ((global::haxe.lang.Function) (new global::haxe.lang.Closure(this, "handleData", 1627978226)) );
					}
					
					
					case 414206607:
					{
						return ((global::haxe.lang.Function) (new global::haxe.lang.Closure(this, "sendHandshake", 414206607)) );
					}
					
					
					case 1695321753:
					{
						return ((global::haxe.lang.Function) (new global::haxe.lang.Closure(this, "processThread", 1695321753)) );
					}
					
					
					case 1860333403:
					{
						return this.binaryType;
					}
					
					
					case 1601313232:
					{
						return this._encodedKey;
					}
					
					
					case 1058852512:
					{
						return this._key;
					}
					
					
					case 593395418:
					{
						return this._processThread;
					}
					
					
					case 1059352685:
					{
						return this._uri;
					}
					
					
					case 2104336224:
					{
						return this._port;
					}
					
					
					case 2015619911:
					{
						return this._host;
					}
					
					
					default:
					{
						return base.__hx_getField(field, hash, throwErrors, isCheck, handleProperties);
					}
					
				}
				
			}
		}
		
		
		public override double __hx_getField_f(string field, int hash, bool throwErrors, bool handleProperties) {
			unchecked {
				switch (hash) {
					case 2104336224:
					{
						return ((double) (this._port) );
					}
					
					
					default:
					{
						return base.__hx_getField_f(field, hash, throwErrors, handleProperties);
					}
					
				}
				
			}
		}
		
		
		public override object __hx_invokeField(string field, int hash, object[] dynargs) {
			unchecked {
				switch (hash) {
					case 1627978226:
					{
						return global::haxe.lang.Runtime.slowCallField(this, field, dynargs);
					}
					
					
					case 875946231:
					{
						this.handshake(((global::hx.ws.HttpResponse) (((object) (dynargs[0]) )) ));
						break;
					}
					
					
					case 414206607:
					{
						this.sendHandshake();
						break;
					}
					
					
					case 1695321753:
					{
						this.processThread();
						break;
					}
					
					
					default:
					{
						return base.__hx_invokeField(field, hash, dynargs);
					}
					
				}
				
				return null;
			}
		}
		
		
		public override void __hx_getFields(global::haxe.root.Array baseArr) {
			baseArr.push("binaryType");
			baseArr.push("_encodedKey");
			baseArr.push("_key");
			baseArr.push("_processThread");
			baseArr.push("_uri");
			baseArr.push("_port");
			baseArr.push("_host");
			base.__hx_getFields(baseArr);
		}
		
		
	}
}



#pragma warning disable 109, 114, 219, 429, 168, 162
namespace hx.ws {
	public class WebSocket___hx_ctor_hx_ws_WebSocket_182__Fun : global::haxe.lang.Function {
		
		public WebSocket___hx_ctor_hx_ws_WebSocket_182__Fun(global::hx.ws.WebSocket ws) : base(0, 0) {
			this.ws = ws;
		}
		
		
		public override object __hx_invoke0_o() {
			unchecked {
				global::haxe.Log.trace.__hx_invoke2_o(default(double), global::haxe.lang.Runtime.concat("\u7ebf\u7a0b\u5f00\u59cb Thread started", global::haxe.lang.Runtime.toString(this.ws.id)), default(double), new global::haxe.lang.DynamicObject(new int[]{302979532, 1547539107, 1648581351}, new object[]{"new", "hx.ws.WebSocket", "src/hx/ws/WebSocket.hx"}, new int[]{1981972957}, new double[]{((double) (183) )}));
				while (( this.ws.state != global::hx.ws.State.Closed )) {
					this.ws.process();
					global::System.Threading.Thread.Sleep(((int) (10) ));
				}
				
				global::hx.ws.Log.debug("Thread ended", this.ws.id);
				return null;
			}
		}
		
		
		public global::hx.ws.WebSocket ws;
		
	}
}


